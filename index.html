<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keonlabs_personal budget-KLPB</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --neon-blue: #00f2ff;
            --deep-blue: #000b1a;
            --panel-bg: rgba(0, 242, 255, 0.03);
            --border-glow: rgba(0, 242, 255, 0.4);
            --text-main: #e0faff;
            --danger: #ff4d4d;
            --warning: #ffaa00;
            --success: #00ff88;
        }

        body { 
            font-family: 'Segoe UI Semibold', sans-serif; 
            background-color: var(--deep-blue); color: var(--neon-blue); 
            margin: 0; padding: 0; 
            background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 11, 26, 0.98); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-card { background: var(--panel-bg); border: 1px solid var(--border-glow); padding: 40px; border-radius: 10px; width: 350px; text-align: center; }

        .container { max-width: 1100px; margin: auto; padding: 20px; display: none; }
        .tabs { display: flex; justify-content: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-glow); overflow-x: auto; }
        .tab-btn { background: transparent; border: none; color: var(--text-main); padding: 15px 25px; cursor: pointer; opacity: 0.5; transition: 0.4s; white-space: nowrap; }
        .tab-btn.active { opacity: 1; color: var(--neon-blue); border-bottom: 3px solid var(--neon-blue); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        
        section { background: var(--panel-bg); border: 1px solid var(--border-glow); padding: 30px; border-radius: 4px; margin-bottom: 20px; }
        
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .metric-box { border: 1px solid var(--border-glow); padding: 20px; border-radius: 8px; text-align: center; background: rgba(0,0,0,0.4); box-shadow: inset 0 0 10px rgba(0,242,255,0.1); }

        input, select { background: rgba(0, 20, 40, 0.8); border: 1px solid var(--border-glow); color: var(--neon-blue); padding: 12px; width: 100%; margin: 10px 0; box-sizing: border-box; }
        button { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 12px; cursor: pointer; width: 100%; text-transform: uppercase; transition: 0.3s; }
        button:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        th { text-align: left; color: #70a1ff; padding: 10px; border-bottom: 1px solid var(--border-glow); }
        td { padding: 10px; border-bottom: 1px solid rgba(0, 242, 255, 0.1); }

        .bar-container { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--neon-blue); transition: width 0.6s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card">
        <h2>KLPB_AUTH_GATE</h2>
        <input type="email" id="authEmail" placeholder="USER_EMAIL">
        <input type="password" id="authPass" placeholder="ACCESS_KEY">
        <button onclick="loginUser()">INITIALIZE_SESSION</button>
        <button onclick="registerUser()" style="border-color: var(--success); color: var(--success); margin-top: 10px;">REGISTER</button>
        <p id="authMsg"></p>
    </div>
</div>

<div class="container" id="mainApp">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <small id="userDisplay"></small>
        <button onclick="logoutUser()" style="width: auto; padding: 5px 15px; font-size: 0.7rem;">TERMINATE</button>
    </div>

    <h1 style="text-align: center; letter-spacing: 5px; text-shadow: 0 0 10px var(--neon-blue);">KEONLABS PERSONAL BUDGET</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'personal')">01_PERSONAL</button>
        <button class="tab-btn" onclick="openTab(event, 'business')">02_BUSINESS</button>
        <button class="tab-btn" onclick="openTab(event, 'analytics')">03_ANALYTICS</button>
        <button class="tab-btn" onclick="openTab(event, 'summary')">04_SUMMARY</button>
    </div>

    <div id="personal" class="tab-content active">
        <section>
            <h2>// PERSONAL_FINANCE</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <select id="pMonth"><option value="0">JAN</option><option value="1">FEB</option><option value="2">MAR</option><option value="3">APR</option><option value="4">MAY</option><option value="5">JUN</option><option value="6">JUL</option><option value="7">AUG</option><option value="8">SEP</option><option value="9">OCT</option><option value="10">NOV</option><option value="11">DEC</option></select>
                <input type="number" id="pBudget" placeholder="BUDGET LIMIT (K)">
            </div>
            <input type="text" id="pItem" placeholder="ITEM NAME">
            <input type="number" id="pCost" placeholder="COST (K)">
            <button onclick="addPersonal()">LOG_EXPENSE</button>
            <table id="pTable"><thead><tr><th>MONTH</th><th>ITEM</th><th>COST</th><th>ACTION</th></tr></thead><tbody></tbody></table>
        </section>
    </div>

    <div id="business" class="tab-content">
        <section>
            <h2>// CAPITAL_&_INVENTORY</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                <input type="text" id="bName" placeholder="PRODUCT NAME">
                <input type="number" id="bBuy" placeholder="BUY_PRICE (K)">
                <input type="number" id="bSell" placeholder="SELL_PRICE (K)">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <input type="number" id="bStock" placeholder="STOCK QTY">
                <select id="bMonth"><option value="0">JAN</option><option value="1">FEB</option><option value="2">MAR</option><option value="3">APR</option><option value="4">MAY</option><option value="5">JUN</option><option value="6">JUL</option><option value="7">AUG</option><option value="8">SEP</option><option value="9">OCT</option><option value="10">NOV</option><option value="11">DEC</option></select>
            </div>
            <button onclick="addBusiness()">INITIALIZE_STOCK</button>
            <table id="bTable"><thead><tr><th>ITEM</th><th>CAPITAL_INV</th><th>SELL_VAL</th><th>STOCK</th><th>ACTION</th></tr></thead><tbody></tbody></table>
        </section>
    </div>

    <div id="analytics" class="tab-content">
        <section>
            <h2>// PERFORMANCE_METRICS</h2>
            <div id="graphicalMetrics" class="metric-grid"></div>
        </section>
    </div>

    <div id="summary" class="tab-content">
        <section>
            <h2>// YEARLY_FINANCIAL_BREAKDOWN</h2>
            <table id="ySummaryTable">
                <thead><tr><th>MONTH</th><th>PERS_EXPENSE</th><th>BUS_CAPITAL_INV</th><th>EST_REVENUE</th><th>POTENTIAL_PROFIT</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://osloiqymubajtacarwze.supabase.co';
const SUPABASE_KEY = 'sb_publishable_bEVd8mvJlf4Z2bcll61a7g_r8eQe_Ad';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let personalData = [], businessData = [];
const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

// --- AUTH (STABLE) ---
async function loginUser() {
    const { error } = await supabaseClient.auth.signInWithPassword({
        email: document.getElementById('authEmail').value, password: document.getElementById('authPass').value
    });
    if (error) document.getElementById('authMsg').innerText = error.message;
}
async function registerUser() {
    const { error } = await supabaseClient.auth.signUp({
        email: document.getElementById('authEmail').value, password: document.getElementById('authPass').value
    });
    if (error) document.getElementById('authMsg').innerText = "Verify Email";
}
async function logoutUser() { await supabaseClient.auth.signOut(); location.reload(); }

supabaseClient.auth.onAuthStateChange((event, session) => {
    if (session) {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userDisplay').innerText = `ID: ${session.user.email}`;
        loadData(session.user.id);
    }
});

// --- CORE SYNC ---
async function syncData() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    await supabaseClient.from('user_budgets').upsert({
        user_id: user.id, payload: { personalData, businessData }, updated_at: new Date()
    });
}
async function loadData(userId) {
    const { data } = await supabaseClient.from('user_budgets').select('payload').eq('user_id', userId).maybeSingle();
    if (data?.payload) {
        personalData = data.payload.personalData || [];
        businessData = data.payload.businessData || [];
        renderAll();
    }
}

// --- LOGIC ---
function addPersonal() {
    const item = document.getElementById('pItem').value;
    const cost = parseFloat(document.getElementById('pCost').value);
    const month = parseInt(document.getElementById('pMonth').value);
    if (item && cost) {
        personalData.push({ id: Date.now(), item, cost, month });
        renderAll(); syncData();
        document.getElementById('pItem').value = ''; document.getElementById('pCost').value = '';
    }
}

function addBusiness() {
    const name = document.getElementById('bName').value;
    const buy = parseFloat(document.getElementById('bBuy').value);
    const sell = parseFloat(document.getElementById('bSell').value);
    const stock = parseInt(document.getElementById('bStock').value);
    const month = parseInt(document.getElementById('bMonth').value);
    if (name && buy && sell) {
        businessData.push({ id: Date.now(), name, buy, sell, stock, month });
        renderAll(); syncData();
        ['bName', 'bBuy', 'bSell', 'bStock'].forEach(id => document.getElementById(id).value = '');
    }
}

function deleteItem(type, id) {
    if (type === 'p') personalData = personalData.filter(x => x.id !== id);
    else businessData = businessData.filter(x => x.id !== id);
    renderAll(); syncData();
}

function renderAll() {
    const pt = document.querySelector("#pTable tbody");
    pt.innerHTML = personalData.map(x => `<tr><td>${months[x.month]}</td><td>${x.item}</td><td>K ${x.cost}</td><td><button onclick="deleteItem('p', ${x.id})" style="padding:2px 8px; width:auto;">X</button></td></tr>`).join('');

    const bt = document.querySelector("#bTable tbody");
    bt.innerHTML = businessData.map(x => {
        const capital = x.buy * x.stock;
        const potentialRevenue = x.sell * x.stock;
        return `<tr><td>${x.name}</td><td>K ${capital}</td><td>K ${potentialRevenue}</td><td>${x.stock}</td><td><button onclick="deleteItem('b', ${x.id})" style="padding:2px 8px; width:auto;">X</button></td></tr>`;
    }).join('');

    updateAnalytics();
    updateYearlySummary();
}

function updateAnalytics() {
    const totalP = personalData.reduce((s, x) => s + x.cost, 0);
    const totalCapital = businessData.reduce((s, x) => s + (x.buy * x.stock), 0);
    const totalProfit = businessData.reduce((s, x) => s + ((x.sell - x.buy) * x.stock), 0);
    
    const container = document.getElementById('graphicalMetrics');
    container.innerHTML = `
        <div class="metric-box">
            <small>TOTAL_INVESTED_CAPITAL</small>
            <h3 style="color:var(--warning)">K ${totalCapital.toLocaleString()}</h3>
            <div class="bar-container"><div class="bar-fill" style="width: 100%; background: var(--warning)"></div></div>
        </div>
        <div class="metric-box">
            <small>PERSONAL_EXPENDITURE</small>
            <h3 style="color:var(--danger)">K ${totalP.toLocaleString()}</h3>
            <div class="bar-container"><div class="bar-fill" style="width: ${Math.min(100, (totalP/totalCapital)*100)}%; background: var(--danger)"></div></div>
        </div>
        <div class="metric-box">
            <small>ESTIMATED_NET_PROFIT</small>
            <h3 style="color:var(--success)">K ${totalProfit.toLocaleString()}</h3>
            <div class="bar-container"><div class="bar-fill" style="width: ${Math.min(100, (totalProfit/totalCapital)*100)}%; background: var(--success)"></div></div>
        </div>
    `;
}

function updateYearlySummary() {
    const st = document.querySelector("#ySummaryTable tbody");
    let html = "";
    for(let i=0; i<12; i++) {
        const pMonth = personalData.filter(x => x.month === i).reduce((s, x) => s + x.cost, 0);
        const bCapital = businessData.filter(x => x.month === i).reduce((s, x) => s + (x.buy * x.stock), 0);
        const bRevenue = businessData.filter(x => x.month === i).reduce((s, x) => s + (x.sell * x.stock), 0);
        const bProfit = bRevenue - bCapital;
        
        html += `<tr>
            <td>${months[i]}</td>
            <td style="color:var(--danger)">K ${pMonth}</td>
            <td style="color:var(--warning)">K ${bCapital}</td>
            <td style="color:var(--neon-blue)">K ${bRevenue}</td>
            <td style="color:var(--success)">K ${bProfit}</td>
        </tr>`;
    }
    st.innerHTML = html;
}

function openTab(evt, tabName) {
    document.querySelectorAll(".tab-content, .tab-btn").forEach(x => x.classList.remove("active"));
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}
</script>
</body>
</html>
