<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KLPB Business Engine</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#000b1a;color:#e0faff}
.container{max-width:1200px;margin:auto;padding:15px;display:none}
.auth-card{max-width:320px;margin:120px auto;padding:25px;background:#001a33;border-radius:8px;text-align:center}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:4px;border:none}
button{cursor:pointer;font-weight:bold}
.btn-main{background:#00ff88;color:#000}
.tab-btn{background:#002244;color:#00f2ff;padding:8px;margin-right:4px;border:none}
.tab-btn.active{background:#00f2ff;color:#000}
.tab-content{display:none}
.tab-content.active{display:block}
.archive-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #003}
.archive-box{border:1px solid #ffaa00;padding:15px;margin-top:15px}
</style>
</head>

<body>

<div id="authOverlay">
  <div class="auth-card">
    <h2>KLPB ENGINE</h2>
    <input id="authEmail" placeholder="Email">
    <input id="authPass" type="password" placeholder="Password">
    <button class="btn-main" onclick="loginUser()">LOGIN</button>
  </div>
</div>

<div class="container" id="mainApp">

<h3 id="userDisplay"></h3>

<div class="tabs">
  <button class="tab-btn active" onclick="openTab(event,'summary')">Reports</button>
</div>

<div id="summary" class="tab-content active">

<table width="100%" border="1">
<thead>
<tr><th>MONTH</th><th>CAP</th><th>REV</th><th>PROFIT</th></tr>
</thead>
<tbody id="ySummaryTable"></tbody>
</table>

<button class="btn-main" style="background:#ffaa00" onclick="archiveYear()">ARCHIVE YEAR</button>

<div class="archive-box">
<button onclick="toggleArchives()" style="background:none;color:#00f2ff;border:none;width:100%">
PAST ARCHIVES <i id="archiveIcon" class="fas fa-chevron-down"></i>
</button>

<div id="archiveList" style="display:none"></div>

<button id="bulkBtn" onclick="exportBulkHistory()" style="display:none" class="btn-main">
EXPORT ALL TIME DATA
</button>
</div>

</div>
</div>

<script>
const SUPABASE_URL = 'https://osloiqymubajtacarwze.supabase.co';
const SUPABASE_KEY = 'sb_publishable_bEVd8mvJlf4Z2bcll61a7g_r8eQe_Ad';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let businessData=[],stockHistory=[],personalLedger=[],debtors=[],withdrawals=[],archiveVault=[];
let lastLoginPass='';

async function loginUser(){
 const email=authEmail.value,pass=authPass.value;
 const {error}=await supabase.auth.signInWithPassword({email,password:pass});
 if(!error)lastLoginPass=pass;
}

supabase.auth.onAuthStateChange(async(e,s)=>{
 if(s){
  authOverlay.style.display='none';
  mainApp.style.display='block';
  userDisplay.innerText=s.user.email;
  loadData(s.user.id);
 }
});

async function syncData(){
 const u=(await supabase.auth.getUser()).data.user;
 if(!u)return;
 await supabase.from('user_budgets').upsert({
  user_id:u.id,
  payload:{businessData,stockHistory,personalLedger,debtors,withdrawals,archiveVault}
 });
}

async function loadData(uid){
 const {data}=await supabase.from('user_budgets').select('payload').eq('user_id',uid).maybeSingle();
 if(data?.payload){
  businessData=data.payload.businessData||[];
  stockHistory=data.payload.stockHistory||[];
  personalLedger=data.payload.personalLedger||[];
  debtors=data.payload.debtors||[];
  withdrawals=data.payload.withdrawals||[];
  archiveVault=data.payload.archiveVault||[];
 }
 renderArchiveList();
}

function archiveYear(){
 const year=prompt("Enter Year");
 if(!year)return;

 const cap=stockHistory.reduce((s,x)=>s+(+x.cost||0),0);
 const rev=businessData.reduce((s,x)=>s+(+x.totalSalesRevenue||0),0);
 const withs=withdrawals.reduce((s,x)=>s+(+x.amount||0),0);

 archiveVault.push({
  year,
  timestamp:new Date().toISOString(),
  summary:{
   totalCap:cap,
   totalRev:rev,
   totalWithdrawals:withs,
   netYearProfit:rev-cap-withs
  },
  data:{
   businessData:JSON.parse(JSON.stringify(businessData)),
   stockHistory:JSON.parse(JSON.stringify(stockHistory)),
   personalLedger:JSON.parse(JSON.stringify(personalLedger)),
   debtors:JSON.parse(JSON.stringify(debtors)),
   withdrawals:JSON.parse(JSON.stringify(withdrawals))
  }
 });

 businessData=[];stockHistory=[];personalLedger=[];debtors=[];withdrawals=[];
 syncData();renderArchiveList();
 alert("YEAR ARCHIVED");
}

function toggleArchives(){
 const l=archiveList,i=archiveIcon,b=bulkBtn;
 if(l.style.display==='none'){
  l.style.display='block';i.className='fas fa-chevron-up';b.style.display='block';
 }else{
  l.style.display='none';i.className='fas fa-chevron-down';b.style.display='none';
 }
}

function renderArchiveList(){
 if(!archiveVault.length){
  archiveList.innerHTML="<p>No archives</p>";
  return;
 }
 archiveList.innerHTML=archiveVault.map((v,i)=>`
 <div class="archive-item">
  <div><b>${v.year}</b><br>
  <small>Profit K${v.summary.netYearProfit.toFixed(2)}</small></div>
  <div>
   <button onclick="downloadTextReport(${i})">â¬‡</button>
   <button onclick="deleteArchive(${i})">ðŸ—‘</button>
  </div>
 </div>`).join('');
}

function downloadTextReport(i){
 const v=archiveVault[i];
 const t=`YEAR ${v.year}
Revenue K${v.summary.totalRev}
Capital K${v.summary.totalCap}
Profit K${v.summary.netYearProfit}`;
 const a=document.createElement('a');
 a.href=URL.createObjectURL(new Blob([t]));
 a.download=`Archive_${v.year}.txt`;a.click();
}

function deleteArchive(i){
 if(confirm("Delete archive?")){
  archiveVault.splice(i,1);
  syncData();renderArchiveList();
 }
}

function exportBulkHistory(){
 let t="ALL TIME HISTORY\n";
 archiveVault.forEach(v=>t+=`${v.year} PROFIT K${v.summary.netYearProfit}\n`);
 const a=document.createElement('a');
 a.href=URL.createObjectURL(new Blob([t]));
 a.download="KLPB_All_Time.txt";a.click();
}

function openTab(e,t){
 document.querySelectorAll('.tab-btn,.tab-content').forEach(x=>x.classList.remove('active'));
 e.target.classList.add('active');
 document.getElementById(t).classList.add('active');
}
</script>
</body>
</html>
