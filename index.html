<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KLPB Business Engine v5.5.0</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --neon-blue: #00f2ff; --deep-blue: #000b1a; --panel-bg: rgba(0, 11, 26, 0.85);
            --border-glow: rgba(0, 242, 255, 0.4); --text-main: #e0faff;
            --danger: #ff4d4d; --warning: #ffaa00; --success: #00ff88;
            --notif-purple: rgba(191, 0, 255, 0.8); 
        }

        /* --- BACKGROUND ENGINE --- */
        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: #000; overflow: hidden; }
        .bg-media { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; transition: opacity 0.5s; position: absolute; top:0; left:0; }

        /* --- NOTIFICATION ERRORS (Per Instructions: Translucent Purple) --- */
        #customNotification {
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(191, 0, 255, 0.7); color: white; padding: 25px 40px;
            border-radius: 20px; backdrop-filter: blur(15px); z-index: 99999;
            display: none; text-align: center; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 30px rgba(191, 0, 255, 0.5); font-weight: bold;
        }

        body { font-family: 'Segoe UI', sans-serif; color: var(--text-main); margin: 0; background: transparent; }
        .container { max-width: 1200px; margin: auto; padding: 15px; display: none; }
        
        /* --- OVERDUE LOGIC (5 Days) --- */
        .overdue-row { border-left: 5px solid var(--danger) !important; background: rgba(255, 77, 77, 0.15) !important; animation: pulse-danger 2s infinite; }
        @keyframes pulse-danger { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        section { background: var(--panel-bg); border: 1px solid var(--border-glow); padding: 18px; border-radius: 12px; margin-bottom: 15px; backdrop-filter: blur(10px); }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .tab-btn { flex: 1; min-width: 90px; background: rgba(0,0,0,0.5); border: 1px solid var(--border-glow); color: var(--text-main); padding: 12px; cursor: pointer; border-radius: 8px; font-size: 0.7rem; font-weight: bold; }
        .tab-btn.active { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        
        input, select { background: rgba(0, 15, 30, 0.8); border: 1px solid var(--border-glow); color: white; padding: 12px; width: 100%; margin: 6px 0; border-radius: 8px; outline: none; }
        .btn-main { background: var(--success); color: #000; padding: 14px; width: 100%; border: none; font-weight: bold; cursor: pointer; border-radius: 8px; text-transform: uppercase; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { background: rgba(0, 242, 255, 0.1); color: var(--neon-blue); padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .action-btn { width: 38px; height: 38px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: 0.3s; }
        .reminder-tag { font-size: 0.65rem; color: var(--warning); display: block; margin-top: 4px; font-style: italic; }
        
        .year-sep { background: linear-gradient(90deg, transparent, var(--notif-purple), transparent); text-align: center; font-weight: bold; color: white; padding: 5px; }
    </style>
</head>
<body>

<div id="bg-container">
    <video id="bg-video" class="bg-media" autoplay muted loop playsinline style="display:none;"></video>
    <img id="bg-img" class="bg-media" style="display:none;">
</div>

<div id="customNotification"></div>

<div id="authOverlay" style="display: flex; align-items: center; justify-content: center; height: 100vh;">
    <div class="section" style="width: 320px; background: var(--panel-bg); padding: 25px; border-radius: 15px; border: 1px solid var(--border-glow); text-align:center;">
        <h2 style="color:var(--neon-blue); margin-bottom:20px;">KLPB ENGINE</h2>
        <div id="loginGroup">
            <input type="email" id="authEmail" placeholder="Email Address">
            <input type="password" id="authPass" placeholder="Password">
            <button onclick="handleAuth('login')" class="btn-main">LOGIN</button>
            <div style="margin-top: 15px; font-size: 0.8rem;">
                <span onclick="forgotPassword()" style="color:var(--warning); cursor:pointer;">Reset Password</span> | 
                <span onclick="toggleAuth(true)" style="color:var(--success); cursor:pointer;">Create Account</span>
            </div>
        </div>
        <div id="signupGroup" style="display:none;">
            <input type="email" id="regEmail" placeholder="New Email">
            <input type="password" id="regPass" placeholder="New Password">
            <button onclick="handleAuth('signup')" class="btn-main" style="background:var(--neon-blue)">REGISTER</button>
            <p onclick="toggleAuth(false)" style="color:var(--text-main); cursor:pointer; font-size: 0.8rem; margin-top:15px;">Back to Login</p>
        </div>
    </div>
</div>

<div id="mainApp" class="container">
    
    <div style="background: rgba(191, 0, 255, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; gap: 8px; border: 1px solid var(--notif-purple);">
        <select id="globalMonth" onchange="renderAll()" style="margin:0; flex:1;"></select>
        <select id="globalYear" onchange="renderAll()" style="margin:0; flex:1;"></select>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'business')">STOCK</button>
        <button class="tab-btn" onclick="openTab(event, 'debtors')">DEBTORS</button>
        <button class="tab-btn" onclick="openTab(event, 'ledger')">LEDGER</button>
        <button class="tab-btn" onclick="openTab(event, 'settings')">BG SETTINGS</button>
    </div>

    <div id="business" class="tab-content active">
        <section>
            <input type="text" id="bName" placeholder="Item Name">
            <div style="display:flex; gap:5px;">
                <input type="number" id="bSell" placeholder="Price K">
                <input type="number" id="bStock" placeholder="Qty">
            </div>
            <button onclick="addBusiness()" class="btn-main">ADD ITEM</button>
            <div style="overflow-x:auto; margin-top:20px;">
                <table id="bTable"><thead><tr><th>ITEM</th><th>STOCK</th><th>ACTION</th></tr></thead><tbody></tbody></table>
            </div>
        </section>
    </div>

    <div id="debtors" class="tab-content">
        <section>
            <h4 style="color:var(--warning); margin:0 0 10px 0;">CLIENT DEBTS (MAX 5 DAYS)</h4>
            <div style="overflow-x:auto;">
                <table id="debtTable">
                    <thead><tr><th>CLIENT</th><th>AMT</th><th>TIMER</th><th>ACTION</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="ledger" class="tab-content">
        <section>
            <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                <button class="tab-btn active" id="btnFilterAll" onclick="setFilter('ALL')">ALL</button>
                <button class="tab-btn" id="btnFilterInc" onclick="setFilter('SALE')">INCOME</button>
                <button class="tab-btn" id="btnFilterExp" onclick="setFilter('CAPITAL')">EXPENSES</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="ledgerTable"><thead><tr><th>DATE</th><th>DESC</th><th>TYPE</th><th>AMT</th></tr></thead><tbody></tbody></table>
            </div>
            <div style="margin-top:15px; text-align:right; font-weight:bold; color:var(--notif-purple);">TOTAL: K <span id="ledgerTotal">0.00</span></div>
        </section>
    </div>

    <div id="settings" class="tab-content">
        <section>
            <h3 style="color:var(--neon-blue); margin-top:0;">MEDIA ENGINE</h3>
            <label style="font-size:0.7rem;">PASTE IMAGE/VIDEO URL:</label>
            <input type="text" id="bgUrl" placeholder="https://...">
            <label style="font-size:0.7rem; margin-top:10px; display:block;">OR UPLOAD FILE:</label>
            <input type="file" id="bgFile" accept="video/*,image/*">
            <button onclick="applyBackground()" class="btn-main" style="background:var(--notif-purple); color:white; margin-top:15px;">SAVE BACKGROUND</button>
        </section>
    </div>
</div>

<script>
// --- CORE CONFIG & DATA ---
const SUPABASE_URL = 'https://osloiqymubajtacarwze.supabase.co';
const SUPABASE_KEY = 'sb_publishable_bEVd8mvJlf4Z2bcll61a7g_r8eQe_Ad';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let businessData = [], debtors = [], globalLedger = [], currentFilter = 'ALL';
const months = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];

// --- INITIALIZE TIMELINE (100 YEARS) ---
function initTimeline() {
    const mSelect = document.getElementById('globalMonth');
    mSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
    mSelect.value = new Date().getMonth();

    const ySelect = document.getElementById('globalYear');
    let yHTML = "";
    // Starts at 2025 and adds 100 years
    for(let y=2025; y<=2125; y++) yHTML += `<option value="${y}">YEAR ${y}</option>`;
    ySelect.innerHTML = yHTML;
    ySelect.value = new Date().getFullYear() < 2025 ? 2025 : new Date().getFullYear();
}

// --- BACKGROUND ENGINE ---
function applyBackground() {
    const url = document.getElementById('bgUrl').value;
    const file = document.getElementById('bgFile').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => updateBG(e.target.result, file.type.includes('video') ? 'video' : 'image');
        reader.readAsDataURL(file);
    } else if (url) {
        const type = (url.match(/\.(mp4|webm|ogg)$/i)) ? 'video' : 'image';
        updateBG(url, type);
    }
}

function updateBG(src, type) {
    const v = document.getElementById('bg-video'), i = document.getElementById('bg-img');
    if (type === 'video') { i.style.display = 'none'; v.style.display = 'block'; v.src = src; }
    else { v.style.display = 'none'; i.style.display = 'block'; i.src = src; }
    showNotify("BACKGROUND SAVED");
}

// --- WHATSAPP REMINDER LOGIC ---
function sendReminder(id) {
    const d = debtors.find(x => x.id === id);
    const dateStr = new Date().toLocaleDateString();
    const msg = `Greetings ${d.name}, a reminder for your balance of K${d.amount} for ${d.item}. Please settle at your earliest convenience. Thanks!`;
    
    d.lastReminded = dateStr; // Record the reminder
    window.open(`https://wa.me/${d.phone}?text=${encodeURIComponent(msg)}`, '_blank');
    renderAll();
    syncData();
}

// --- SMART RENDER ENGINE ---
function renderAll() {
    const activeMonth = parseInt(document.getElementById('globalMonth').value);
    const activeYear = parseInt(document.getElementById('globalYear').value);
    const today = new Date();

    // 1. STOCK
    document.querySelector("#bTable tbody").innerHTML = businessData.map(x => `
        <tr>
            <td><b>${x.name}</b><br><small>K${x.price}</small></td>
            <td style="color:${x.stock < 5 ? 'var(--danger)':'var(--success)'}">${x.stock}</td>
            <td>
                <button class="action-btn" style="background:var(--success)" onclick="sell(${x.id}, false)"><i class="fas fa-cash-register"></i></button>
                <button class="action-btn" style="background:var(--warning)" onclick="sell(${x.id}, true)"><i class="fas fa-user-clock"></i></button>
            </td>
        </tr>
    `).join('');

    // 2. DEBTORS (5 Day Overdue Logic)
    document.querySelector("#debtTable tbody").innerHTML = debtors.map(d => {
        const created = new Date(d.date);
        const days = Math.ceil(Math.abs(today - created) / (1000 * 60 * 60 * 24));
        const isOverdue = days > 5;
        return `
            <tr class="${isOverdue ? 'overdue-row' : ''}">
                <td>
                    <b>${d.name}</b>
                    <span class="reminder-tag">${d.lastReminded ? 'Last Reminded: '+d.lastReminded : 'No reminder sent'}</span>
                </td>
                <td style="color:var(--danger)">K${d.amount}</td>
                <td>${isOverdue ? 'EXPIRED' : days+'/5 Days'}</td>
                <td>
                    <button class="action-btn" style="background:#25D366" onclick="sendReminder(${d.id})"><i class="fab fa-whatsapp"></i></button>
                    <button class="action-btn" style="background:var(--success)" onclick="payDebt(${d.id})"><i class="fas fa-check"></i></button>
                </td>
            </tr>
        `;
    }).join('');

    // 3. LEDGER (Corrected Expense/Income Filtering)
    let totalVal = 0;
    const filteredLedger = globalLedger.filter(l => {
        if (currentFilter === 'ALL') return true;
        if (currentFilter === 'CAPITAL') return (l.type === 'CAPITAL' || l.type === 'EXPENSE');
        return l.type === currentFilter;
    }).filter(l => l.month === activeMonth && l.year === activeYear).reverse();

    document.querySelector("#ledgerTable tbody").innerHTML = filteredLedger.map(l => {
        const isInc = ['SALE', 'INCOME'].includes(l.type);
        totalVal += isInc ? l.amt : -l.amt;
        return `<tr>
            <td style="font-size:0.6rem;">${l.date}</td>
            <td>${l.desc}</td>
            <td style="font-size:0.6rem; opacity:0.6;">${l.type}</td>
            <td style="color:${isInc ? 'var(--success)':'var(--danger)'}">K${l.amt}</td>
        </tr>`;
    }).join('');
    document.getElementById('ledgerTotal').innerText = totalVal.toFixed(2);
}

// --- BUSINESS CORE ---
function sell(id, isDebt) {
    const item = businessData.find(x => x.id === id);
    if(item.stock <= 0) return showNotify("OUT OF STOCK", true);
    
    if(isDebt) {
        const name = prompt("Debtor Name:");
        const phone = prompt("WhatsApp Number (e.g. 260...):");
        if(name && phone) {
            debtors.push({ id:Date.now(), name, phone, amount:item.price, item:item.name, date:new Date().toISOString(), lastReminded:null });
            logToLedger(`Debt: ${item.name} to ${name}`, 'DEBT', item.price);
            item.stock--;
        }
    } else {
        item.stock--;
        logToLedger(`Sale: ${item.name}`, 'SALE', item.price);
    }
    renderAll(); syncData();
}

function payDebt(id) {
    const d = debtors.find(x => x.id === id);
    logToLedger(`Paid Debt: ${d.name}`, 'SALE', d.amount);
    debtors = debtors.filter(x => x.id !== id);
    renderAll(); syncData();
}

function addBusiness() {
    const n = document.getElementById('bName').value, p = document.getElementById('bSell').value, q = document.getElementById('bStock').value;
    if(n && p) {
        businessData.push({ id:Date.now(), name:n, price:parseFloat(p), stock:parseInt(q) });
        logToLedger(`Added Stock: ${n}`, 'CAPITAL', 0);
        renderAll(); syncData();
    }
}

function logToLedger(desc, type, amt) {
    globalLedger.push({
        date: new Date().toLocaleDateString(),
        desc, type, amt: parseFloat(amt),
        month: parseInt(document.getElementById('globalMonth').value),
        year: parseInt(document.getElementById('globalYear').value)
    });
}

// --- AUTH & SYNC ---
async function handleAuth(type) {
    const email = type === 'login' ? document.getElementById('authEmail').value : document.getElementById('regEmail').value;
    const password = type === 'login' ? document.getElementById('authPass').value : document.getElementById('regPass').value;
    const { error } = type === 'login' ? await supabaseClient.auth.signInWithPassword({ email, password }) : await supabaseClient.auth.signUp({ email, password });
    if(error) showNotify(error.message, true);
}

async function forgotPassword() {
    const email = document.getElementById('authEmail').value;
    if(!email) return showNotify("Please enter your email", true);
    const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
    showNotify(error ? error.message : "Reset link sent to email!", !!error);
}

async function syncData() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if(user) await supabaseClient.from('user_budgets').upsert({ user_id: user.id, payload: { businessData, debtors, globalLedger } });
}

async function loadData(uid) {
    const { data } = await supabaseClient.from('user_budgets').select('payload').eq('user_id', uid).maybeSingle();
    if(data?.payload) {
        businessData = data.payload.businessData || [];
        debtors = data.payload.debtors || [];
        globalLedger = data.payload.globalLedger || [];
    }
    renderAll();
}

supabaseClient.auth.onAuthStateChange((event, session) => {
    if (session) {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadData(session.user.id);
    }
});

// --- UI HELPERS ---
function showNotify(msg, isError = false) {
    const el = document.getElementById('customNotification');
    el.innerHTML = msg; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
}
function toggleAuth(s) { document.getElementById('loginGroup').style.display = s ? 'none' : 'block'; document.getElementById('signupGroup').style.display = s ? 'block' : 'none'; }
function openTab(e, t) { document.querySelectorAll('.tab-content, .tab-btn').forEach(x => x.classList.remove('active')); document.getElementById(t).classList.add('active'); e.currentTarget.classList.add('active'); }
function setFilter(f) { 
    currentFilter = f; 
    document.querySelectorAll('#ledger .tab-btn').forEach(b => b.classList.remove('active'));
    renderAll(); 
}

window.onload = initTimeline;
</script>
</body>
</html>
