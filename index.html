<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLPB - Reinvestment Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --neon-blue: #00f2ff;
            --deep-blue: #000b1a;
            --panel-bg: rgba(0, 242, 255, 0.1);
            --border-glow: rgba(0, 242, 255, 0.4);
            --text-main: #e0faff;
            --danger: #ff4d4d;
            --success: #00ff88;
            --warning: #ffaa00;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--deep-blue); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        section { background: var(--panel-bg); border: 1px solid var(--border-glow); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .metric-box { border: 1px solid var(--border-glow); padding: 15px; border-radius: 8px; text-align: center; background: rgba(0,0,0,0.3); }
        
        input, select { background: #001428; border: 1px solid var(--border-glow); color: var(--neon-blue); padding: 10px; width: 100%; margin: 5px 0; border-radius: 4px; }
        button { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 10px; cursor: pointer; width: 100%; transition: 0.3s; margin-top: 5px; border-radius: 4px; }
        button:hover { background: var(--neon-blue); color: #000; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; border-bottom: 1px solid var(--border-glow); color: var(--neon-blue); font-size: 0.8rem; }
        td { padding: 10px; border-bottom: 1px solid rgba(0, 242, 255, 0.1); font-size: 0.85rem; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; border-bottom: 2px solid transparent; opacity: 0.6; }
        .tab-btn.active { opacity: 1; border-bottom: 2px solid var(--neon-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center; color: var(--neon-blue); letter-spacing: 3px;">KLPB BUSINESS ENGINE</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'biz')">INVENTORY & SALES</button>
        <button class="tab-btn" onclick="openTab(event, 'stats')">ANALYTICS & VAULT</button>
    </div>

    <div id="biz" class="tab-content active">
        <section>
            <div class="metric-grid" id="topStats"></div>
            <h3>// ADD STOCK</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <input type="text" id="itemName" placeholder="ITEM">
                <input type="number" id="itemCap" placeholder="CAPITAL (K)">
                <input type="number" id="itemQty" placeholder="QTY">
            </div>
            <input type="number" id="itemSell" placeholder="RETAIL SELL PRICE (K)">
            <button onclick="addItem()">INITIALIZE STOCK</button>
        </section>

        <section>
            <h3>// CURRENT STOCK</h3>
            <table>
                <thead><tr><th>ITEM</th><th>TOTAL CAP</th><th>QTY</th><th>REVENUE</th><th>ACTION</th></tr></thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </section>
    </div>

    <div id="stats" class="tab-content">
        <section>
            <h2>// FINANCIAL PERFORMANCE</h2>
            <div class="metric-grid" id="analyticsGrid"></div>
            <button onclick="withdrawProfit()" style="border-color: var(--danger); color: var(--danger);">WITHDRAW PROFIT</button>
        </section>

        <section>
            <h3>// ARCHIVE VAULT</h3>
            <table id="vaultTable">
                <thead><tr><th>YEAR/PERIOD</th><th>CAPITAL</th><th>REINVESTED</th><th>SALES</th><th>WITHDRAWN</th></tr></thead>
                <tbody id="vaultBody"></tbody>
            </table>
            <button onclick="archiveYear()" style="margin-top: 20px;">ARCHIVE CURRENT DATA</button>
        </section>
    </div>
</div>

<script>
// Logic State
let items = [], history = [], vault = [], totalWithdrawn = 0, totalReinvested = 0;

function addItem() {
    const name = document.getElementById('itemName').value;
    const cap = parseFloat(document.getElementById('itemCap').value);
    const qty = parseInt(document.getElementById('itemQty').value);
    const sell = parseFloat(document.getElementById('itemSell').value);

    if (name && !isNaN(cap)) {
        items.push({ id: Date.now(), name, capital: cap, qty, sell, revenue: 0 });
        history.push({ type: 'Purchase', name, amt: cap, qty });
        render();
    }
}

function sellRetail(id) {
    const item = items.find(i => i.id === id);
    if (item.qty > 0) {
        item.qty -= 1;
        item.revenue += item.sell;
        render();
    } else { alert("OUT OF STOCK"); }
}

function restockItem(id) {
    const item = items.find(i => i.id === id);
    const qty = parseInt(prompt("QTY TO ADD:"));
    const cost = parseFloat(prompt("COST (K):"));
    const useProfit = confirm("USE EXISTING PROFIT (REINVEST)? \nCancel means using NEW external capital.");

    if (!isNaN(cost)) {
        item.qty += qty;
        item.capital += cost;
        if (useProfit) {
            totalReinvested += cost;
            history.push({ type: 'Reinvestment', name: item.name, amt: cost, qty });
        } else {
            history.push({ type: 'Purchase', name: item.name, amt: cost, qty });
        }
        render();
    }
}

function withdrawProfit() {
    const totalRev = items.reduce((s, i) => s + i.revenue, 0);
    const totalCap = items.reduce((s, i) => s + i.capital, 0);
    const availableProfit = totalRev - totalCap - totalWithdrawn;

    if (availableProfit <= 0) return alert("NO PROFIT AVAILABLE TO WITHDRAW");
    
    const amt = parseFloat(prompt(`Available Profit: K${availableProfit}. Amount to withdraw:`));
    if (amt > 0 && amt <= availableProfit) {
        totalWithdrawn += amt;
        render();
    } else { alert("INVALID AMOUNT"); }
}

function render() {
    const totalCap = items.reduce((s, i) => s + i.capital, 0);
    const totalRev = items.reduce((s, i) => s + i.revenue, 0);
    const netProfit = totalRev - totalCap;

    // Analytics Grid
    document.getElementById('analyticsGrid').innerHTML = `
        <div class="metric-box"><small>TOTAL CAPITAL</small><h2 style="color:var(--warning)">K ${totalCap}</h2></div>
        <div class="metric-box"><small>TOTAL REINVESTED</small><h2 style="color:var(--neon-blue)">K ${totalReinvested}</h2></div>
        <div class="metric-box"><small>TOTAL SALES</small><h2 style="color:var(--success)">K ${totalRev}</h2></div>
        <div class="metric-box"><small>WITHDRAWN</small><h2 style="color:var(--danger)">K ${totalWithdrawn}</h2></div>
        <div class="metric-box"><small>BUSINESS CASH ON HAND</small><h2>K ${totalRev - totalWithdrawn}</h2></div>
    `;

    // Inventory
    document.getElementById('inventoryBody').innerHTML = items.map(i => `
        <tr>
            <td>${i.name}</td>
            <td>K ${i.capital}</td>
            <td style="color:${i.qty < 5 ? 'var(--danger)' : 'white'}">${i.qty}</td>
            <td>K ${i.revenue}</td>
            <td>
                <button onclick="sellRetail(${i.id})" style="width:auto; padding:5px;">SELL</button>
                <button onclick="restockItem(${i.id})" style="width:auto; padding:5px; border-color:var(--warning); color:var(--warning);">RESTOCK</button>
            </td>
        </tr>
    `).join('');

    // Vault
    document.getElementById('vaultBody').innerHTML = vault.map(v => `
        <tr><td>${v.year}</td><td>K ${v.cap}</td><td>K ${v.reinvest}</td><td>K ${v.sales}</td><td>K ${v.withdrawn}</td></tr>
    `).join('');
}

function archiveYear() {
    const label = prompt("Year Label:");
    if (!label) return;
    vault.push({
        year: label,
        cap: items.reduce((s, i) => s + i.capital, 0),
        reinvest: totalReinvested,
        sales: items.reduce((s, i) => s + i.revenue, 0),
        withdrawn: totalWithdrawn
    });
    items = []; totalWithdrawn = 0; totalReinvested = 0;
    render();
}

function openTab(evt, name) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    evt.currentTarget.classList.add('active');
}

render();
</script>
</body>
</html>
